/* Autogenerated file. Manual edits will not be saved.*/

#nullable enable
using System;
using mud;
using UniRx;
using Property = System.Collections.Generic.Dictionary<string, object>;

namespace <%= namespace %>
{

	public class <%= tableClassName %> : MUDTable
	{

		public class <%= tableClassName %>Update : RecordUpdate {
			<% for (const field of fields) { -%>
				public <%= field.type %>? <%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>;
				public <%= field.type %>? Previous<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>;
			<% } -%>
		}

		public readonly static string ID = "<%= tableName %>";
		public static RxTable Table {get{return NetworkManager.Instance.ds.store[ID]; } }
		public override string GetTableId() {return ID;}

		<% for (const field of fields) { -%>
			public <%= field.type %>? <%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>;
		<% } -%>

		public override Type TableType() {return typeof(<%= tableClassName %>);}
		public override Type TableUpdateType() {return typeof(<%= tableClassName %>Update);}
		
		public override bool Equals (object? obj) {
			<%= tableClassName %> other = (<%= tableClassName %>)obj;

			if(other == null) {return false;}
			<% for (const field of fields) { -%>
				if(<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %> != other.<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>) {return false;}
			<% } -%>
			return true;
		}
		public override void SetValues(params object[] functionParameters){

			<% var i = 0 -%>
			<% for (const field of fields) { -%>
				<% if (field.type === "long" || field.type === "ulong") { -%> 
				<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %> = (<%= field.type %>)(int)functionParameters[<%= i -%>];
				<% } else { -%> 
				<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %> = (<%= field.type %>)functionParameters[<%= i -%>];
				<% } -%> 
				<% i++ -%>
			<% } -%>
		}

		public static IObservable<RecordUpdate> Get<%= tableClassName %>Updates() {

			<%= tableClassName %> mudTable = new <%= tableClassName %>();

			return NetworkManager.Instance.sync.onUpdate
			.Where(update => update.Table.Name == ID)
			.Select(
				recordUpdate => {
					return mudTable.RecordUpdateToTyped(recordUpdate);
				});
		}

		public override void PropertyToTable(Property property) {
			<% for (const field of fields) { -%>
				<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %> = (<%= field.type %>)property["<%= field.key %>"];
			<% } -%>
		}

		public override RecordUpdate RecordUpdateToTyped(RecordUpdate recordUpdate) {

			var currentValue = recordUpdate.CurrentRecordValue as Property;
			var previousValue = recordUpdate.PreviousRecordValue as Property;
			 <% for (const field of fields) { -%>
				  <%= field.type %>? current<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed = null;
				  <%= field.type %>? previous<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed = null;
				
				  if (currentValue != null && currentValue.ContainsKey("<%= field.key.toLowerCase() %>")) {
				    <% if (field.type.startsWith("uint") || field.type.startsWith("Uint")) { -%>
				      current<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed = (<%= field.type %>)(<%= field.type.charAt(0).toUpperCase() === field.type.charAt(0) ? field.type.slice(1).toUpperCase() : field.type.slice(1) %>)currentValue["<%= field.key.toLowerCase() %>"];
				    <% } else { -%>
				      current<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed = (<%= field.type %>)currentValue["<%= field.key.toLowerCase() %>"];
				    <% } -%>
				  }
				
				  if (previousValue != null && previousValue.ContainsKey("<%= field.key.toLowerCase() %>")) {
				    <% if (field.type.startsWith("uint") || field.type.startsWith("Uint")) { -%>
				      previous<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed = (<%= field.type %>)(<%= field.type.charAt(0).toUpperCase() === field.type.charAt(0) ? field.type.slice(1).toUpperCase() : field.type.slice(1) %>)previousValue["<%= field.key.toLowerCase() %>"];
				    <% } else { -%>
				      previous<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed = (<%= field.type %>)previousValue["<%= field.key.toLowerCase() %>"];
				    <% } -%>	
				 }
				<% } -%>
	

			
			return new <%= tableClassName %>Update
			{
				Table = recordUpdate.Table,
				CurrentRecordValue = recordUpdate.CurrentRecordValue,
				PreviousRecordValue = recordUpdate.PreviousRecordValue,				
				CurrentRecordKey = recordUpdate.CurrentRecordKey,
				PreviousRecordKey = recordUpdate.PreviousRecordKey,
				Type = recordUpdate.Type,
				
				<% for (const field of fields) { -%>
					<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %> = current<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed,
					Previous<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %> = previous<%= field.key.charAt(0).toUpperCase() + field.key.slice(1) %>Typed,	
				<% } -%>
			};
		}


	}
}
